{% extends 'superadmin/base_admin.html' %}
{% load humanize %}
{% load static %}
{% load widget_tweaks %}

{% block page_title %}Dashboard{% endblock %}

{% block sidebar_stats %}
<div class="sidebar-stats">
    <div class="stat-card">
        <div class="stat-card-title">Monthly Revenue</div>
        <div class="stat-card-value">₦{{ period_revenue|floatformat:0|intcomma }}</div>
        <div class="stat-card-growth {% if revenue_growth >= 0 %}positive{% else %}negative{% endif %}">
            <i class="fas fa-arrow-{% if revenue_growth >= 0 %}up{% else %}down{% endif %}"></i>
            {{ revenue_growth|floatformat:1 }}% from previous
        </div>
    </div>
    <div class="stat-card">
        <div class="stat-card-title">Total Users</div>
        <div class="stat-card-value">{{ total_users|intcomma }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-title">Total Hotels</div>
        <div class="stat-card-value">{{ total_hotels|intcomma }}</div>
    </div>
    <div class="stat-card">
        <div class="stat-card-title">Total Customers</div>
        <div class="stat-card-value">{{ total_customers|intcomma }}</div>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Date Range Form -->
<form method="get" class="mb-4">
    <div class="row">
        <div class="col-md-3">
            {{ form.start_date|add_class:"form-control" }}
        </div>
        <div class="col-md-3">
            {{ form.end_date|add_class:"form-control" }}
        </div>
        <div class="col-md-3">
            <select name="view" class="form-select" onchange="this.form.submit()">
                <option value="monthly" {% if view_type == 'monthly' %}selected{% endif %}>Monthly</option>
                <option value="weekly" {% if view_type == 'weekly' %}selected{% endif %}>Weekly</option>
                <option value="daily" {% if view_type == 'daily' %}selected{% endif %}>Daily</option>
            </select>
        </div>
        <div class="col-md-3">
            <button type="submit" class="btn btn w-100">Filter</button>
        </div>
    </div>
</form>

<!-- KPI Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card shadow-sm border-0 text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Revenue</h6>
                <h4 class="fw-bold text-dark">₦{{ total_revenue|floatformat:2|intcomma }}</h4>
                <small class="text-muted">All-time commission</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card shadow-sm border-0 text-center">
            <div class="card-body">
                <h6 class="text-muted">Period Revenue</h6>
                <h4 class="fw-bold text-primary">₦{{ period_revenue|floatformat:2|intcomma }}</h4>
                <small class="text-muted">Filtered period</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card shadow-sm border-0 text-center">
            <div class="card-body">
                <h6 class="text-muted">Total Bookings</h6>
                <h4 class="fw-bold text-success">{{ total_bookings|intcomma }}</h4>
                <small class="text-muted">All-time</small>
            </div>
        </div>
    </div>
    <div class="col-md-3 col-sm-6 mb-3">
        <div class="card shadow-sm border-0 text-center">
            <div class="card-body">
                <h6 class="text-muted">Revenue Growth</h6>
                <h4 class="fw-bold {% if revenue_growth >= 0 %}text-success{% else %}text-danger{% endif %}">{{ revenue_growth|floatformat:1 }}%</h4>
                <small class="text-muted">vs previous period</small>
            </div>
        </div>
    </div>
</div>

<!-- Chart with toggle (matching sales report) -->
<div class="card shadow-sm border-0 mb-5">
    <div class="card-body">
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <h5 class="card-title mb-0">Revenue Trend</h5>
            <div class="btn-group mt-2 mt-sm-0" role="group">
                <button class="btn btn-sm btn-outline{% if view_type == 'daily' %}active{% endif %}" onclick="updateChart('daily')">Daily</button>
                <button class="btn btn-sm btn-outline{% if view_type == 'weekly' %}active{% endif %}" onclick="updateChart('weekly')">Weekly</button>
                <button class="btn btn-sm btn-outline{% if view_type == 'monthly' %}active{% endif %}" onclick="updateChart('monthly')">Monthly</button>
            </div>
        </div>
        <canvas id="revenueChart" height="120"></canvas>
    </div>
</div>

<!-- Recent Hotels Table (matching sales report table style) -->
<div class="table-responsive mb-4">
    <table class="table table-striped table-hover">
        <thead class="table-dark">
            <tr>
                <th>Name</th>
                <th>Owner</th>
                <th>Status</th>
                <th>Created</th>
            </tr>
        </thead>
        <tbody>
            {% for hotel in recent_hotels %}
            <tr>
                <td>
                    <a href="{% url 'superadmin_hotel_detail' hotel.slug %}" class="text-decoration-none fw-medium">{{ hotel.name }}</a>
                </td>
                <td>{{ hotel.owner.full_name|default:hotel.owner.email }}</td>
                <td>
                    {% if hotel.is_approved %}
                        <span class="badge bg-success">Approved</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">Pending</span>
                    {% endif %}
                </td>
                <td>{{ hotel.created_at|date:"M d, Y" }}</td>
            </tr>
            {% empty %}
            <tr>
                <td colspan="4" class="text-center">No recent hotels</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chart;
const ctx = document.getElementById('revenueChart').getContext('2d');

function renderChart(labels, data) {
    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Revenue (₦)',
                data: data,
                backgroundColor: '#001f3f'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (value >= 1000000) return (value / 1000000).toFixed(1) + 'M';
                            if (value >= 1000) return (value / 1000).toFixed(1) + 'K';
                            return value;
                        }
                    }
                }
            }
        }
    });
}

// Default load (based on view_type)
let labels = {{ chart_labels|safe }};
let data = {{ chart_data|safe }};
renderChart(labels, data);

// Toggle function (submit form with view param)
function updateChart(type) {
    const select = document.querySelector('select[name="view"]');
    select.value = type;
    select.form.submit();
}
</script>

<!-- Custom Styles (matching sales report) -->
<style>
/* Keep cards same height */
.card {
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}
.card h6 {
    font-size: 0.9rem;
}
.card h4 {
    font-size: 1.2rem;
    word-break: break-word;
}
.btn {
    border-radius: 0rem;
    background-color: #121643;
    color: #ffffff;
}
.btn:hover{
    background-color: #0e123a;
    color: #ffffff;
}

/* Chart header responsiveness */
@media (max-width: 576px) {
    .card-title {
        font-size: 1rem;
    }
    .btn-group button {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
}
</style>
{% endblock %}