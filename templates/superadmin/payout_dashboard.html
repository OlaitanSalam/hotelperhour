{% extends 'superadmin/base_admin.html' %}
{% load humanize %}

{% block page_title %}Hotel Payouts{% endblock %}

{% block content %}
{% csrf_token %}
<!-- KPI Summary Cards – 4 Perfect Cards -->
<div class="row g-3 mb-4">
    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
        <div class="card shadow-sm border-0 text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="text-muted">Payable Now (4+ days)</h6>
                <h4 class="fw-bold text-success">₦{{ total_payable_payout|floatformat:2|intcomma }}</h4>
                <small class="text-muted">{{ total_hotels_ready }} hotels ready</small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
        <div class="card shadow-sm border-0 text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="text-muted">Pending Revenue </br> (0–3 days)</h6>
                <h4 class="fw-bold text-warning">₦{{ total_pending_payout|floatformat:2|intcomma }}</h4>
                <small class="text-muted">Still in holding period</small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
        <div class="card shadow-sm border-0 text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="text-muted">Cutoff Date</h6>
                <h4 class="fw-bold text-primary">{{ cutoff_date|date:"M d, Y" }}</h4>
                <small class="text-muted">Bookings before this are payable</small>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-lg-3 col-md-6 col-sm-6">
        <div class="card shadow-sm border-0 text-center h-100">
            <div class="card-body d-flex flex-column justify-content-center">
                <h6 class="text-muted">Hotels Ready for Payout</h6>
                <h4 class="fw-bold text-info">{{ total_hotels_ready }}</h4>
                <small class="text-muted">Need action today</small>
            </div>
        </div>
    </div>
</div>

<!-- Big Navy Blue History Button – Below KPIs -->
<div class="text-center mb-5">
    <a href="{% url 'superadmin_payout_history' %}" class="btn btn-sm px-3 py-3" 
       style="background-color: #121643; color: white; border-radius: 0; font-weight: 600;">
        <i class="fas fa-history me-2"></i>
        VIEW PAYOUT HISTORY
    </a>
</div>

<!-- Info Box -->
<div class="alert alert-info">
    <i class="fas fa-info-circle"></i> <strong>How it works:</strong>
    <ul class="mb-0 mt-2">
        <li><strong>Pending Revenue:</strong> Bookings made 0-3 days ago (still in holding period)</li>
        <li><strong>Payable Revenue:</strong> Bookings made 4+ days ago (ready for payout)</li>
        <li>After creating a payout, pay the hotel via Paystack dashboard, then mark as "Completed" here</li>
    </ul>
</div>

<!-- Hotels Table -->
<div class="card shadow-sm">
    <div class="card-body">
        <h5 class="card-title mb-4"><i class="fas fa-hotel"></i> Hotels Payout Dashboard</h5>
        
        {% if hotel_data %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Hotel</th>
                        <th>Account Details</th>
                        <th class="text-end">Pending Revenue<br><small class="text-muted">(0-3 days)</small></th>
                        <th class="text-end">Payable Revenue<br><small class="text-muted">(4+ days)</small></th>
                        <th class="text-end">Net Payout<br><small class="text-muted">(After 10% comm.)</small></th>
                        <th class="text-center">Status</th>
                        <th class="text-center">Last Paid</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for data in hotel_data %}
                    <tr>
                        <td>
                            <strong>{{ data.hotel.name }}</strong><br>
                            <small class="text-muted">{{ data.booking_count }} bookings</small>
                        </td>
                        <td>
                            <small>
                                <strong>{{ data.hotel.bank_name }}</strong><br>
                                {{ data.hotel.account_number }}<br>
                                {{ data.hotel.account_name }}
                            </small>
                        </td>
                        <td class="text-end">
                            <span class="badge bg-warning">₦{{ data.pending_revenue|floatformat:2|intcomma }}</span>
                        </td>
                        <td class="text-end">
                            <strong class="text-success">₦{{ data.payable_revenue|floatformat:2|intcomma }}</strong>
                        </td>
                        <td class="text-end">
                            <strong class="text-primary">₦{{ data.net_payout|floatformat:2|intcomma }}</strong><br>
                            <small class="text-muted">Commission: ₦{{ data.commission|floatformat:2|intcomma }}</small>
                        </td>
                        <td class="text-center">
                            {% if data.status == 'ready' %}
                                <span class="badge bg-success">Ready</span>
                            {% elif data.status == 'overdue' %}
                                <span class="badge bg-danger">Overdue</span>
                            {% else %}
                                <span class="badge bg-secondary">No Revenue</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            {% if data.last_payout_date %}
                                {{ data.last_payout_date|date:"M d" }}<br>
                                <small class="text-muted">Next: {{ data.next_due|date:"M d" }}</small>
                            {% else %}
                                <span class="text-muted">Never</span>
                            {% endif %}
                        </td>
                        <td class="text-center">
    {% if data.net_payout > 0 %}
        {% if data.has_pending_payout %}
            <!-- Show different button if payout already exists -->
            <a href="{% url 'superadmin_payout_detail' payout_id=data.pending_payout_id %}" 
               class="btn btn-sm btn-warning">
                <i class="fas fa-eye"></i> View Pending
            </a>
        {% else %}
            <!-- Normal create button -->
            <button type="button" class="btn btn-sm btn-success" 
                    onclick="confirmPayout('{{ data.hotel.name }}', '{{ data.net_payout|floatformat:2|intcomma }}', {{ data.hotel.id }})">
                <i class="fas fa-check"></i> Create Payout
            </button>
        {% endif %}
    {% else %}
        <button class="btn btn-sm btn-secondary" disabled>No Revenue</button>
    {% endif %}
</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-hotel fa-4x text-muted mb-3"></i>
            <p class="text-muted">No approved hotels with complete banking information</p>
        </div>
        {% endif %}
    </div>
</div>

<style>

.card.h-100 { min-height: 135px; }


</style>
{% block extra_js %}
<script>
function confirmPayout(hotelName, amount, hotelId) {
    // Custom Bootstrap modal confirmation
    if (confirm(`Create payout of ₦${amount} for ${hotelName}?\n\nThis will mark these bookings as ready for payment.`)) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/superadmin/payouts/create/${hotelId}/`;
        
        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfToken) {
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken.value;
            form.appendChild(csrfInput);
        }
        
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
{% endblock %}